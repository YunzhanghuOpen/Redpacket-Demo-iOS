###云账户红包SDK接入指南(iOS)
#####Step 1. 首先注册红包Token，注册完成后会保存到SDK中。

* 基于云账户提供的签名机制进行的校验     [云账户REST API文档](http://yunzhanghu-com.oss-cn-qdjbp-a.aliyuncs.com/%E4%BA%91%E8%B4%A6%E6%88%B7%E7%BA%A2%E5%8C%85%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3-v3_0_1.pdf)
* 
**@file:**`RedpacketLib.h`

```
// 签名无需每次都要请求，请求前请先调用
/**
*  Method1:通过签名的方式获取Token (以下参数的获取方式见RestAPI集成文档)
*
*  @param sign        当前用户的签名 (App Server端获取)
*  @param partner     App ID （商户注册后可得到）
*  @param appUserid   用户在App的用户ID
*  @param timeStamp   时间戳
*/
//  签名方式
+ (RPRedpacketRegisitModel *)signModelWithAppUserId:(NSString *)appUserId signString:(NSString *)sign partner:(NSString *)partner andTimeStamp:(NSString *)timeStamp;        


```

用此方法需要遵循代理

**@protocol:**`RPRedpacketBridgeDelegate`

* 获取当前登录用用户信息

```
/**
*  获取当前用户的信息，用户ID必须要传
*
*  @return 用户信息Info
*/
- (RPUserInfo *)redpacketUserInfo;//需要对userId、userNickname、userAvatar等属性赋值。

```
* 获取当前签名信息的代理方法
```

/** 使用红包服务时，如果红包Token不存在或者过期，则回调此方法，需要在RedpacketRegisitModel生成后，通过fetchBlock回传给红包SDK
* 如果错误error不为空，签名方式， 则刷新签名.
*/
- (void)redpacketFetchRegisitParam:(RPFetchRegisitParamBlock)fetchBlock withError:(NSError *)error;


```
#####Step 2. 调用发红包页面
* 发送点对点、群红包、包含专属红包的群红包页面调用

```

typedef NS_ENUM(NSInteger,RPRedpacketControllerType){
RPRedpacketControllerTypeSingle,    //点对点红包
RPRedpacketControllerTypeRand,      //小额度随机红包
RPRedpacketControllerTypeGroup,     //群红包
};

/*!
发送红包方法

@required
@param RPRedpacketControllerType   发送红包类型（点对点红包 小额度红包  只限在单人聊天中使用）
@param fromeController             当前页面控制器
@param count                       群成员人数（可传0）
@param receiver                    红包接受者信息(群组时接收者ID为当前会话ID，头像，昵称不传)
@param sendBlock        红包发送成功后的回调

@optional
@param memberBlock      专属红包获取群成员回调（非专属红包不传）
*/
+ (void)presentRedpacketViewController:(RPRedpacketControllerType)controllerType fromeController:(UIViewController *)fromeController groupMemberCount:(NSInteger)count withRedpacketReceiver:(RPUserInfo *)receiver andSuccessBlock:(RedpacketSendBlock)sendBlock withFetchGroupMemberListBlock:(RedpacketMemberListBlock)memberBlock;    

``` 

#####Step 3. 调用抢红包页面
* 抢红包的方法

```
@class:RedpacketViewControl
/*!
抢红包方法

@required
@param model 红包相关信息(发红包成功后会产生一个消息体，有这个消息体转换而来)
@param fromViewController 当前页面控制器
@param grabTouch          抢红包成功后的回调
@optional
@param advertisementAction 广告红包用户行为回调(广告红包后才需要传)
*/
+ (void)redpacketTouchedWithMessageModel:(RPRedpacketModel *)model fromViewController:(UIViewController *)fromViewController redpacketGrabBlock:(RedpacketGrabBlock)grabTouch advertisementAction:(RedpacketAdvertisementActionBlock)advertisementAction; 

```

* model的生成解析成

**@file:**`RPRedpacketUnionHandle.h`

```
//  IM通道中传入的Dict
+ (RPRedpacketModel *)modelWithChannelRedpacketDic:(NSDictionary *)redpacketDic andSender:(RPUserInfo *)sender;

```

#####Step 4. 获取零钱和零钱页面

```
@class:RedpacketViewControl
// 红包记录页面
+ (void)presentChangePocketViewControllerFromeController:(UIViewController *)viewController;

```

####Step 5. 有关支付宝
[支付宝集成链接](https://doc.open.alipay.com/doc2/detail.htm?spm=a219a.7629140.0.0.UccR9D&treeId=59&articleId=103676&docType=1)

1. 项目支持支付宝支付，所以请在项目中已经含有支付宝SDK，和支付宝需要的相关Framework.
Build Phases中添加支付宝的依赖库**CoreMotion.framework**

2. App Transport Security Settings需要支持支付宝

3. 添加URLScheme回调, 默认为`App的identifier Bundle`， 并通过`RedpacketBridge`中的`redacketURLScheme`传入SDK。

4. 请在[集成Demo](https://github.com/YunzhanghuOpen/Redpacket-Demo-iOS) 中查找`AppDelegate+Redpacket`，在工程中引入即可

5. TARGETS->Info->URL Types 添加支付宝回调，即自己的 Bundle Identifier。

6. 如果原项目中有支付宝SDK，只能保留一个支付宝SDK即可。

##### 可能的错误

* 链接标记

Bulid Settings 中，Other Linker Flags标记
如果没有请加上 -ObjC
如果是-force_load，请加上libRedpacket.a的路径地址

* Build Phases中支付宝的依赖库**CoreMotion.framework**是否缺失。

* 参见5，检查支付宝相关配置是否正确。
[支付宝集成链接](https://doc.open.alipay.com/doc2/detail.htm?spm=a219a.7629140.0.0.UccR9D&treeId=59&articleId=103676&docType=1)

> 联系我们:

* 客服热线: **400-6565-739**
* 业务咨询: **bd@yunzhanghu.com**
* 客服 QQ :  **4006565739**
* 技术QQ群: **366135448**


